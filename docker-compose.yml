name: ${COMPOSE_PROJECT_NAME:-cht-sync}
version: '3.8'

x-dbt-base: &dbt-common
  build: ./dbt/
  working_dir: /dbt/
  environment: &dbt-env
    POSTGRES_HOST: ${POSTGRES_HOST}
    POSTGRES_PORT: ${POSTGRES_PORT:-5432}
    POSTGRES_USER: ${POSTGRES_USER}
    POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    POSTGRES_DB: ${POSTGRES_DB}
    POSTGRES_TABLE: ${POSTGRES_TABLE}
    POSTGRES_SCHEMA: ${POSTGRES_SCHEMA}
    ROOT_POSTGRES_SCHEMA: ${POSTGRES_SCHEMA}
    DATAEMON_INTERVAL: ${DATAEMON_INTERVAL}
    DBT_THREAD_COUNT: ${DBT_THREAD_COUNT}
    DBT_BATCH_SIZE: ${DBT_BATCH_SIZE}

services:
  couch2pg:
    build: ./couch2pg/
    extra_hosts:
      - "host.docker.internal:host-gateway"
    logging:
      driver: "json-file"
      options:
        max-size: "512m"
    environment:
      <<: *dbt-env
      COUCHDB_USER: ${COUCHDB_USER}
      COUCHDB_PASSWORD: ${COUCHDB_PASSWORD}
      COUCHDB_HOST: ${COUCHDB_HOST}
      COUCHDB_DBS: ${COUCHDB_DBS}
      COUCHDB_PORT: ${COUCHDB_PORT}
      COUCHDB_SECURE: ${COUCHDB_SECURE:-true}
    restart: always

  dbt:
    <<: *dbt-common
    profiles:
      - default
    environment:
      <<: *dbt-env
      DBT_SELECTOR: ''
      CHT_PIPELINE_BRANCH_URL: ${CHT_PIPELINE_BRANCH_URL}

  dbt-base:
    <<: *dbt-common
    profiles:
      - base-and-package
    environment:
      <<: *dbt-env
      DBT_SELECTOR: tag:base
      CHT_PIPELINE_BRANCH_URL: ${CHT_PIPELINE_BRANCH_URL}

  dbt-models:
    <<: *dbt-common
    profiles:
      - base-and-package
    depends_on:
      - dbt-base
    environment:
      <<: *dbt-env
      DBT_SELECTOR: package:${DBT_PACKAGE_NAME}
      CHT_PIPELINE_BRANCH_URL: ${CHT_PIPELINE_BRANCH_URL}

  dbt-contacts:
    <<: *dbt-common
    volumes:
      - "${DBT_LOCAL_PATH}:/dbt/package/"
    profiles:
      - test
    environment:
      <<: *dbt-env
      DBT_SELECTOR: tag:contacts
      DBT_LOCAL_PATH: ${DBT_LOCAL_PATH}

  dbt-reports:
    <<: *dbt-common
    volumes:
      - "${DBT_LOCAL_PATH}:/dbt/package/"
    profiles:
     - test
    depends_on:
      - dbt-contacts
    environment:
      <<: *dbt-env
      DBT_SELECTOR: tag:reports
      DBT_LOCAL_PATH: ${DBT_LOCAL_PATH}
